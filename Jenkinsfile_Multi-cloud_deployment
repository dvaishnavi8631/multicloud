pipeline {
    agent any
    environment {
        // AWS Variables
        AWS_REGION = 'eu-west-1'
        ECR_REGISTRY = '250738637992.dkr.ecr.eu-west-1.amazonaws.com'
        SSO_PROFILE = 'MSCCLOUD-250738637992'
        ECR_REPOSITORY = 'x23183209-multicloud'
        K8S_NAMESPACE = 'default'
        DEPLOYMENT_NAME = 'simple-app-deployment'

        // GCP Variables
        GCP_PROJECT = 'elegant-hope-441319-t6'
        GKE_CLUSTER = 'gcp-multicloud'
        GKE_REGION = 'europe-west1'
        GKE_ZONE = 'europe-west1-b'  // Added zone variable
        GCLOUD_PATH = '/home/jenkins/google-cloud-sdk/bin'
        IMAGE_NAME_GCP = "europe-docker.pkg.dev/${GCP_PROJECT}/gcp-multicloud/multicloud-app"  // Full image path for GCP

        // Azure Variables
        AZURE_SUBSCRIPTION_ID = '2d101f2e-3531-4cd5-a463-6f697453bb43'
        AZURE_RESOURCE_GROUP = 'Multicloud'
        AKS_CLUSTER_NAME = 'multicloudAKS'
        ACR_REGISTRY = 'x23183209multicloud.azurecr.io'  // ACR name
        IMAGE_NAME_AZURE = "${ACR_REGISTRY}/multicloud-app"  // Full image path for Azure

        // Common Variables
        GIT_REPO = 'https://github.com/dvaishnavi8631/multicloud.git'
        GIT_CREDENTIALS_ID = 'github'
        IMAGE_TAG = 'latest'
    }
    stages {
        stage('Setup and Checkout Code') {
            steps {
                script {
                    echo 'Checking out the Git repository...'
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: '*/main']],
                        userRemoteConfigs: [[
                            url: "${GIT_REPO}",
                            credentialsId: "${GIT_CREDENTIALS_ID}"
                        ]]
                    ])
                }
            }
        }

        // AWS Deployment Stage
        stage('AWS Deployment') {
            steps {
                script {
                    echo 'Ensure AWS SSO login has been performed manually before running the pipeline.'
                    sh "aws sso login --profile ${SSO_PROFILE} --region ${AWS_REGION}"

                    def awsLoginPassword = sh(
                        script: "aws ecr get-login-password --region ${AWS_REGION} --profile ${SSO_PROFILE}",
                        returnStdout: true
                    ).trim()
                    sh "docker login -u AWS -p ${awsLoginPassword} ${ECR_REGISTRY}"

                    echo 'Building Docker image for AWS...'
                    sh "docker build -t ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG} ."

                    echo 'Pushing Docker image to AWS ECR...'
                    sh "docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"

                    echo 'Configuring kubectl for AWS EKS...'
                    sh "aws eks update-kubeconfig --region ${AWS_REGION} --profile ${SSO_PROFILE} --name x23183209-multicloud"

                    echo 'Deploying application to AWS Kubernetes...'
                    sh "kubectl apply -f deployment.yaml"
                    sh "kubectl apply -f service.yaml"
                }
            }
        }

        // GCP Deployment Stage
        stage('GCP Deployment') {
            steps {
                script {
                    echo 'Authenticating with Google Cloud...'
                    withCredentials([file(credentialsId: 'gcpacnt', variable: 'GOOGLE_APPLICATION_CREDENTIALS')]) {
                        sh """
                            export PATH=${GCLOUD_PATH}:$PATH
                            gcloud auth activate-service-account --key-file="${GOOGLE_APPLICATION_CREDENTIALS}"
                            gcloud config set project ${GCP_PROJECT}
                            gcloud auth configure-docker europe-docker.pkg.dev --quiet
                        """

                        echo 'Building Docker image for GCP...'
                        sh """
                            export PATH=${GCLOUD_PATH}:$PATH
                            docker build -t ${IMAGE_NAME_GCP}:${IMAGE_TAG} .
                        """

                        echo 'Pushing Docker image to Google Artifact Registry...'
                        sh """
                            export PATH=${GCLOUD_PATH}:$PATH
                            docker push ${IMAGE_NAME_GCP}:${IMAGE_TAG}
                        """

                        echo 'Getting credentials for GKE...'
                        sh """
                            export PATH=${GCLOUD_PATH}:$PATH
                            gcloud container clusters get-credentials ${GKE_CLUSTER} --zone ${GKE_ZONE} --project ${GCP_PROJECT}
                        """

                        echo 'Deploying application to GCP Kubernetes...'
                        sh """
                            export PATH=${GCLOUD_PATH}:$PATH
                            kubectl apply -f deployment.yaml
                            kubectl apply -f service.yaml
                        """
                    }
                }
            }
        }

        // Azure Deployment Stage
        stage('Azure Deployment') {
            steps {
                script {
                    echo 'Logging into Azure...'
                    withCredentials([
                        string(credentialsId: 'azure-client-id', variable: 'AZURE_CLIENT_ID'),
                        string(credentialsId: 'azure-client-secret', variable: 'AZURE_CLIENT_SECRET'),
                        string(credentialsId: 'azure-tenant-id', variable: 'AZURE_TENANT_ID')
                    ]) {
                        sh """
                            az login --service-principal -u ${AZURE_CLIENT_ID} -p ${AZURE_CLIENT_SECRET} --tenant ${AZURE_TENANT_ID}
                            az account set --subscription ${AZURE_SUBSCRIPTION_ID}
                            az acr login --name ${ACR_REGISTRY}
                        """

                        echo 'Building Docker image for Azure...'
                        sh "docker build -t ${IMAGE_NAME_AZURE}:${IMAGE_TAG} ."

                        echo 'Pushing Docker image to Azure Container Registry...'
                        sh "docker push ${IMAGE_NAME_AZURE}:${IMAGE_TAG}"

                        echo 'Deploying application to Azure Kubernetes...'
                        sh """
                            az aks get-credentials --resource-group ${AZURE_RESOURCE_GROUP} --name ${AKS_CLUSTER_NAME}
                            kubectl apply -f deployment.yaml
                            kubectl apply -f service.yaml
                        """
                    }
                }
            }
        }
    }
    post {
        success {
            echo "Pipeline executed successfully! Application deployed to AWS, GCP, and Azure."
        }
        failure {
            echo "Pipeline failed. Check the logs for details."
        }
    }
}
